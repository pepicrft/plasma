name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  check-releasable:
    name: Check for releasable changes
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
      next_version: ${{ steps.version.outputs.next_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - name: Check for unreleased changes
        id: check
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "No previous tags found, this will be the first release"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            # Check if there are conventional commits since the last tag
            COMMITS_SINCE_TAG=$(git rev-list ${LATEST_TAG}..HEAD --count)

            if [ "$COMMITS_SINCE_TAG" -gt 0 ]; then
              echo "Found $COMMITS_SINCE_TAG commits since last tag"

              # Check if any of these commits are releasable (feat, fix, etc.)
              RELEASABLE=$(git log ${LATEST_TAG}..HEAD --oneline | grep -E '^[a-f0-9]+ (feat|fix|perf|refactor)(\(|:)' || true)

              if [ -n "$RELEASABLE" ]; then
                echo "Found releasable commits:"
                echo "$RELEASABLE"
                echo "has_changes=true" >> $GITHUB_OUTPUT
              else
                echo "No releasable commits found (only chores, docs, etc.)"
                echo "has_changes=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "No commits since last tag"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Calculate next version
        id: version
        if: steps.check.outputs.has_changes == 'true'
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

          # Remove 'v' prefix
          CURRENT_VERSION=${LATEST_TAG#v}

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Check for breaking changes
          if git log ${LATEST_TAG}..HEAD --format=%B | grep -q 'BREAKING CHANGE:'; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          # Check for features
          elif git log ${LATEST_TAG}..HEAD --oneline | grep -qE '^[a-f0-9]+ feat(\(|:)'; then
            MINOR=$((MINOR + 1))
            PATCH=0
          # Otherwise it's a patch (fix, perf, refactor)
          else
            PATCH=$((PATCH + 1))
          fi

          NEXT_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "Next version: $NEXT_VERSION"
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT

  build-macos:
    name: Build macOS
    needs: check-releasable
    if: needs.check-releasable.outputs.has_changes == 'true'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: ". -> target"

      - name: Build frontend
        run: |
          pnpm --dir frontend install
          pnpm --dir frontend build

      - name: Build Tauri app
        run: cargo tauri build
        working-directory: app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Rename artifacts and generate checksums
        run: |
          cd target/release/bundle

          # Rename DMG files to remove version (e.g., Plasma_0.1.0_*.dmg -> Plasma_*.dmg)
          for file in dmg/*.dmg; do
            if [ -f "$file" ]; then
              newname=$(echo "$file" | sed -E 's/_[0-9]+\.[0-9]+\.[0-9]+_/_/')
              if [ "$file" != "$newname" ]; then
                mv "$file" "$newname"
                echo "Renamed: $file -> $newname"
              fi
            fi
          done

          # Generate consolidated checksums
          rm -f sha256.txt sha512.txt
          find . -type f \( -name "*.dmg" -o -name "*.app.tar.gz" \) | while read -r file; do
            filename=$(basename "$file")
            shasum -a 256 "$file" | awk -v fname="$filename" '{print $1 "  " fname}' >> sha256.txt
            shasum -a 512 "$file" | awk -v fname="$filename" '{print $1 "  " fname}' >> sha512.txt
            echo "Generated checksums for: $filename"
          done

          if [ -f sha256.txt ]; then
            echo "=== sha256.txt ==="
            cat sha256.txt
            echo "=== sha512.txt ==="
            cat sha512.txt
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: target/release/bundle/

  build-linux:
    name: Build Linux
    needs: check-releasable
    if: needs.check-releasable.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: ". -> target"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Build frontend
        run: |
          pnpm --dir frontend install
          pnpm --dir frontend build

      - name: Build Tauri app
        run: cargo tauri build
        working-directory: app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Rename artifacts and generate checksums
        run: |
          cd target/release/bundle

          # Rename DEB files to remove version
          for file in deb/*.deb; do
            if [ -f "$file" ]; then
              newname=$(echo "$file" | sed -E 's/_[0-9]+\.[0-9]+\.[0-9]+_/_/')
              if [ "$file" != "$newname" ]; then
                mv "$file" "$newname"
                echo "Renamed: $file -> $newname"
              fi
            fi
          done

          # Rename RPM files to remove version (format: name-version-release.arch.rpm -> name.arch.rpm)
          for file in rpm/*.rpm; do
            if [ -f "$file" ]; then
              newname=$(echo "$file" | sed -E 's/-[0-9]+\.[0-9]+\.[0-9]+-[0-9]+\././')
              if [ "$file" != "$newname" ]; then
                mv "$file" "$newname"
                echo "Renamed: $file -> $newname"
              fi
            fi
          done

          # Rename AppImage files to remove version
          for file in appimage/*.AppImage; do
            if [ -f "$file" ]; then
              newname=$(echo "$file" | sed -E 's/_[0-9]+\.[0-9]+\.[0-9]+_/_/')
              if [ "$file" != "$newname" ]; then
                mv "$file" "$newname"
                echo "Renamed: $file -> $newname"
              fi
            fi
          done

          # Generate consolidated checksums
          rm -f sha256.txt sha512.txt
          find . -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.AppImage" \) | while read -r file; do
            filename=$(basename "$file")
            sha256sum "$file" | awk -v fname="$filename" '{print $1 "  " fname}' >> sha256.txt
            sha512sum "$file" | awk -v fname="$filename" '{print $1 "  " fname}' >> sha512.txt
            echo "Generated checksums for: $filename"
          done

          if [ -f sha256.txt ]; then
            echo "=== sha256.txt ==="
            cat sha256.txt
            echo "=== sha512.txt ==="
            cat sha512.txt
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: target/release/bundle/

  build-windows:
    name: Build Windows
    needs: check-releasable
    if: needs.check-releasable.outputs.has_changes == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: ". -> target"

      - name: Build frontend
        run: |
          pnpm --dir frontend install
          pnpm --dir frontend build

      - name: Build Tauri app
        run: cargo tauri build
        working-directory: app
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Rename artifacts and generate checksums
        shell: pwsh
        run: |
          cd target\release\bundle

          # Rename MSI files to remove version
          Get-ChildItem -Path msi -Filter *.msi | ForEach-Object {
            $newName = $_.Name -replace '_[0-9]+\.[0-9]+\.[0-9]+_', '_'
            if ($_.Name -ne $newName) {
              $newPath = Join-Path $_.Directory $newName
              Move-Item $_.FullName $newPath
              Write-Host "Renamed: $($_.Name) -> $newName"
            }
          }

          # Rename NSIS exe files to remove version
          Get-ChildItem -Path nsis -Filter *.exe | ForEach-Object {
            $newName = $_.Name -replace '_[0-9]+\.[0-9]+\.[0-9]+_', '_'
            if ($_.Name -ne $newName) {
              $newPath = Join-Path $_.Directory $newName
              Move-Item $_.FullName $newPath
              Write-Host "Renamed: $($_.Name) -> $newName"
            }
          }

          # Generate consolidated checksums
          Remove-Item -Path sha256.txt -ErrorAction SilentlyContinue
          Remove-Item -Path sha512.txt -ErrorAction SilentlyContinue

          Get-ChildItem -Recurse -Include *.msi,*.exe | ForEach-Object {
            $file = $_.FullName
            $filename = $_.Name
            $hash256 = (Get-FileHash -Algorithm SHA256 $file).Hash.ToLower()
            $hash512 = (Get-FileHash -Algorithm SHA512 $file).Hash.ToLower()
            "$hash256  $filename" | Out-File -FilePath sha256.txt -Append -Encoding ASCII
            "$hash512  $filename" | Out-File -FilePath sha512.txt -Append -Encoding ASCII
            Write-Host "Generated checksums for: $filename"
          }

          if (Test-Path sha256.txt) {
            Write-Host "=== sha256.txt ==="
            Get-Content sha256.txt
            Write-Host "=== sha512.txt ==="
            Get-Content sha512.txt
          }

      - uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: target/release/bundle/

  release:
    name: Create GitHub Release
    needs: [check-releasable, build-macos, build-linux, build-windows]
    if: needs.check-releasable.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - name: Generate changelog
        env:
          NEXT_VERSION: ${{ needs.check-releasable.outputs.next_version }}
        run: |
          # Generate changelog for the upcoming version
          git-cliff --strip all --unreleased --tag $NEXT_VERSION > /tmp/release-notes.txt
          cat /tmp/release-notes.txt

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files

          # Copy distributable packages
          find all-artifacts -type f \( \
            -name "*.dmg" -o \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.AppImage" -o \
            -name "*.msi" -o \
            -name "*.exe" \
          \) -exec cp {} release-files/ \;

          # Consolidate checksums from all platforms
          rm -f release-files/sha256.txt release-files/sha512.txt

          # Merge all sha256.txt files
          find all-artifacts -name "sha256.txt" -exec cat {} \; > release-files/sha256.txt

          # Merge all sha512.txt files
          find all-artifacts -name "sha512.txt" -exec cat {} \; > release-files/sha512.txt

          echo "=== Release files ==="
          ls -lah release-files/
          echo ""
          echo "=== Consolidated sha256.txt ==="
          cat release-files/sha256.txt
          echo ""
          echo "=== Consolidated sha512.txt ==="
          cat release-files/sha512.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-releasable.outputs.next_version }}
          name: ${{ needs.check-releasable.outputs.next_version }}
          body_path: /tmp/release-notes.txt
          files: release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
