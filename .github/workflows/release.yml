name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  check-releasable:
    name: Check for releasable changes
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
      next_version: ${{ steps.version.outputs.next_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - name: Check for unreleased changes
        id: check
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "No previous tags found, this will be the first release"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            # Check if there are conventional commits since the last tag
            COMMITS_SINCE_TAG=$(git rev-list ${LATEST_TAG}..HEAD --count)

            if [ "$COMMITS_SINCE_TAG" -gt 0 ]; then
              echo "Found $COMMITS_SINCE_TAG commits since last tag"

              # Check if any of these commits are releasable (feat, fix, etc.)
              RELEASABLE=$(git log ${LATEST_TAG}..HEAD --oneline | grep -E '^[a-f0-9]+ (feat|fix|perf|refactor)(\(|:)' || true)

              if [ -n "$RELEASABLE" ]; then
                echo "Found releasable commits:"
                echo "$RELEASABLE"
                echo "has_changes=true" >> $GITHUB_OUTPUT
              else
                echo "No releasable commits found (only chores, docs, etc.)"
                echo "has_changes=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "No commits since last tag"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Calculate next version
        id: version
        if: steps.check.outputs.has_changes == 'true'
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

          # Remove 'v' prefix
          CURRENT_VERSION=${LATEST_TAG#v}

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Check for breaking changes
          if git log ${LATEST_TAG}..HEAD --format=%B | grep -q 'BREAKING CHANGE:'; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          # Check for features
          elif git log ${LATEST_TAG}..HEAD --oneline | grep -qE '^[a-f0-9]+ feat(\(|:)'; then
            MINOR=$((MINOR + 1))
            PATCH=0
          # Otherwise it's a patch (fix, perf, refactor)
          else
            PATCH=$((PATCH + 1))
          fi

          NEXT_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "Next version: $NEXT_VERSION"
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT

  build-macos:
    name: Build macOS
    needs: check-releasable
    if: needs.check-releasable.outputs.has_changes == 'true'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: ". -> target"

      - name: Build frontend
        run: |
          pnpm --dir frontend install
          pnpm --dir frontend build

      - name: Build Tauri app
        run: cargo tauri build
        working-directory: app

      - name: Generate checksums
        run: |
          cd target/release/bundle
          find . -type f \( -name "*.dmg" -o -name "*.app" -o -name "*.app.tar.gz" \) -print0 | while IFS= read -r -d '' file; do
            echo "Generating checksums for: $file"
            shasum -a 256 "$file" > "$file.sha256"
            shasum -a 512 "$file" > "$file.sha512"
          done
          find . -type f \( -name "*.sha256" -o -name "*.sha512" \) -ls

      - uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: target/release/bundle/

  build-linux:
    name: Build Linux
    needs: check-releasable
    if: needs.check-releasable.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: ". -> target"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Build frontend
        run: |
          pnpm --dir frontend install
          pnpm --dir frontend build

      - name: Build Tauri app
        run: cargo tauri build
        working-directory: app

      - name: Generate checksums
        run: |
          cd target/release/bundle
          find . -type f \( -name "*.deb" -o -name "*.AppImage" -o -name "*.rpm" \) -print0 | while IFS= read -r -d '' file; do
            echo "Generating checksums for: $file"
            sha256sum "$file" > "$file.sha256"
            sha512sum "$file" > "$file.sha512"
          done
          find . -type f \( -name "*.sha256" -o -name "*.sha512" \) -ls

      - uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: target/release/bundle/

  build-windows:
    name: Build Windows
    needs: check-releasable
    if: needs.check-releasable.outputs.has_changes == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: ". -> target"

      - name: Build frontend
        run: |
          pnpm --dir frontend install
          pnpm --dir frontend build

      - name: Build Tauri app
        run: cargo tauri build
        working-directory: app

      - name: Generate checksums
        shell: pwsh
        run: |
          cd target\release\bundle
          Get-ChildItem -Recurse -Include *.msi,*.exe | ForEach-Object {
            $file = $_.FullName
            Write-Host "Generating checksums for: $file"
            $hash256 = (Get-FileHash -Algorithm SHA256 $file).Hash.ToLower()
            $hash512 = (Get-FileHash -Algorithm SHA512 $file).Hash.ToLower()
            $relativePath = $_.Name
            "$hash256  $relativePath" | Out-File -FilePath "$file.sha256" -Encoding ASCII
            "$hash512  $relativePath" | Out-File -FilePath "$file.sha512" -Encoding ASCII
          }
          Get-ChildItem -Recurse -Include *.sha256,*.sha512

      - uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: target/release/bundle/

  release:
    name: Create GitHub Release
    needs: [check-releasable, build-macos, build-linux, build-windows]
    if: needs.check-releasable.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: jdx/mise-action@v2
        with:
          cache: true

      - name: Generate changelog
        env:
          NEXT_VERSION: ${{ needs.check-releasable.outputs.next_version }}
        run: |
          # Generate changelog for the upcoming version
          git-cliff --strip all --unreleased --tag $NEXT_VERSION > /tmp/release-notes.txt
          cat /tmp/release-notes.txt

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find all-artifacts -type f -exec cp {} release-files/ \;
          ls -lah release-files/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-releasable.outputs.next_version }}
          name: ${{ needs.check-releasable.outputs.next_version }}
          body_path: /tmp/release-notes.txt
          files: release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
